<div id="addfile" data-model="addfileViewModel" data-bind="events: { show: onViewShow, beforeunload: test }" data-role="view" data-layout="default-layout" data-title="Add File">
    <ul data-role="listview" data-bind="source: files" data-template="addfile-item-template" class="data-source sortable"></ul>
    <a data-role="button" class="addfile-btn small" data-bind="visible: filesWaiting, click:openFileDialog"><i class="fa fa-plus"></i>&nbsp;Add File</a>
    <a data-role="button" class="addfile-btn big" data-bind="invisible: filesWaiting, click:openFileDialog"><i class="fa fa-plus"></i>&nbsp;Add File</a>
    <input id="file-input" type="file" name="files[]" data-bind="events: { change:onFileGet }">
    <footer data-role="footer">
        <div data-role="navbar" class="km-accent">
            <a data-role="button" style="width:100%"><i class="fa fa-upload"></i>&nbsp;Upload</a>
        </div>
    </footer>
</div>

<script id="addfile-item-template" type="text/kendo-x-tmpl">
    <div class="file-upload-row">
        <div class="file-upload-row-header">
            <input type="text" name="header" placeholder="Filename" />
            <div>
                <a><i class="fa fa-close"></i></a>
            </div>
        </div>
        <form>
            <label class="km-inline-field km-label-above">
                Folder
                <input type="text" placeholder="Folder" />
            </label>
            <label class="km-inline-field km-label-above">
                Comments
                <input type="text" placeholder="Comments" />
            </label>
            <label class="km-inline-field km-label-above">
                Tags
                <input type="text" placeholder="Tags" />
            </label>
            <label class="km-inline-field km-label-above">
                Checkout File
                <input type="checkbox" data-role="switch" />
            </label>
        </form>
    </div>
</script>

<script>
    var addfileViewModel = {};
    $(function (jQuery) {
        addfileViewModel = new kendo.observable({
            libraryName: '',
            subfolderKey: '',
            libraryItems: [],
            filesToUpload: [],
            onViewShow: function (e) {
                var $this = this;
                var params = e.view.params;
                $this.setParams(params);
                $this.initialiseFileUpload();
                $this.getLibraryItems($this.libraryName, $this.subfolderKey);
                globalOnViewShow(e);
            },
            onFileGet: function (e) {
                debugger;
            },
            openFileDialog: function (e) {
                $("#file-input").click();
            },
            filesWaiting: function () {
                return this.get('filesToUpload').length > 0;
            },
            initialiseFileUpload: function () {
                var $this = this;
                var $fileInput = $('#file-input');

                $fileInput.fileupload({
                    autoUpload: false,
                    url: api.rootUrl + 'DocumentManagement/UploadDocument',
                    add: function (e, data) {
                        $.each(data.files, function (index, file) {
                            var fileName = file.name;
                            var extension = fileName.substr(fileName.lastIndexOf("."));
                            var fileNameWithoutExtension = fileName.substr(0, fileName.lastIndexOf("."));
                            var allowUpload = true;
                            var currentDocument;

                            // Check whether this file already exists in this folder. If so, then display the 'check-in' option rather than upload.
                            for (var i = 0; i < $this.libraryItems.length; i++) {

                                var item = $this.libraryItems[i];
                                if (!item.IsFolder && item.Description && item.Description.toLowerCase() == fileName.toLowerCase()) {

                                    // Check the 'check-out' status of this document
                                    if (item.CheckedOutBy) {

                                        if (item.CheckedOutBy != currentUser.get().username) {
                                            // The document is checked out to another user
                                            alert("This document has been checked out by another user");
                                            allowUpload = false;
                                            data.abort();
                                        }
                                        else {
                                            currentDocument = item;
                                        }
                                    }
                                    else {

                                        if (confirm("You must check out this document before uploading a new version. Would you like to do this now?")) {

                                            // Check out the document now. If not successful then remove the document from the list again

                                            checkOut(item).done(function (result) {

                                            }).fail(function (result) {

                                                // Couldn't check out the document, display an error and remove the document from the upload list
                                                alert("Failed to check out document");


                                                // TODO: This needs testing
                                                data.abort();
                                            });

                                            currentDocument = item;
                                        }
                                        else {
                                            //allowUpload = false;
                                            //data.abort();
                                        }
                                    }

                                    // The file was found so stop looking for it.
                                    break;
                                }
                            }

                            if (allowUpload) {
                                var filesToUpload = $this.get('filesToUpload');
                                filesToUpload.push(item); // here
                                $this.set('filesToUpload', filesToUpload);

                                data;
                                debugger;


                                if (currentDocument) {
                                    // This is a check in of an existing document rather than an upload of a new one.
                                    //$dataContext.find(".upload-document-type").text("Check In Document");
                                    //$dataContext.find(".upload-file-folder-label").hide();
                                    //$dataContext.find(".upload-file-version-label").show();
                                    //$dataContext.find(".upload-folder").hide();
                                    //$dataContext.find(".upload-file-tag").val(currentDocument.Tags);
                                }
                                else {
                                    //$dataContext.find(".upload-version").hide();
                                }
                            }
                        });
                    },
                });
            },
            setParams: function (params) {
                var $this = this;
                for (var param in params) {
                    if (params.hasOwnProperty(param)) {
                        $this.set(param, params[param]);
                    }
                }
            },
            getLibraryItems: function (libraryName, subfolderKey) {
                var $this = this;
                api.documentService().getDocumentsFromLibrary(libraryName, '', subfolderKey).then(function (response) {
                    var results;
                    if (response.constructor == Error) {
                        results = [];
                    } else {
                        results = response.results;
                    }
                    $this.set('libraryItems', results);
                });
            }
        });
    });

    var g = function (e, data) {
        $.each(data.files, function (index, file) {

            var fileName = file.name;
            var extension = fileName.substr(fileName.lastIndexOf("."));
            var fileNameWithoutExtension = fileName.substr(0, fileName.lastIndexOf("."));
            var allowUpload = true;
            var currentDocument;

            // Check whether this file already exists in this folder. If so, then display the 'check-in' option rather than upload.
            for (var i = 0; i < that.Documents.length; i++) {

                var item = that.Documents[i];
                if (!item.IsFolder && item.Filename && item.Filename.toLowerCase() == fileName.toLowerCase()) {

                    // Check the 'check-out' status of this document
                    if (item.CheckedOutBy) {

                        if (item.CheckedOutBy != sanderson.user.name) {
                            // The document is checked out to another user
                            alert("This document has been checked out by another user");
                            allowUpload = false;
                            data.abort();
                        }
                        else {
                            currentDocument = item;
                        }
                    }
                    else {

                        if (confirm("You must check out this document before uploading a new version. Would you like to do this now?")) {

                            // Check out the document now. If not successful then remove the document from the list again

                            checkOut(item).done(function (result) {

                            }).fail(function (result) {

                                // Couldn't check out the document, display an error and remove the document from the upload list
                                alert("Failed to check out document");


                                // TODO: This needs testing
                                data.abort();
                            });

                            currentDocument = item;
                        }
                        else {
                            //allowUpload = false;
                            //data.abort();
                        }
                    }

                    // The file was found so stop looking for it.
                    break;
                }
            }

            if (allowUpload) {

                var template = kendo.template($("#img9a-upload-document-row").html());
                data.currentDocument = currentDocument;
                data.context = $(template({})).data(data);

                data.context.appendTo('.files-list');

                var $dataContext = $(data.context);
                $dataContext.attr("data-filename", fileName);

                $dataContext.find(".upload-file-name").val(fileNameWithoutExtension);
                $dataContext.find(".upload-file-extension").text(extension.toLowerCase());
                $dataContext.find(".upload-file-size").text(parseInt(file.size / 1024) + " KB");
                $dataContext.find(".upload-folder").val(that.CurrentFolder.toUpperCase());
                $dataContext.find(".remove-file-btn").on('click', function () {
                    var $this = $(this);
                    var data = $this.parents(".upload-file-row").data();
                    data.abort();
                    $this.parents(".upload-file-row").remove();
                });

                kendo.bind($dataContext, that);

                if (currentDocument) {
                    // This is a check in of an existing document rather than an upload of a new one.
                    $dataContext.find(".upload-document-type").text("Check In Document");
                    $dataContext.find(".upload-file-folder-label").hide();
                    $dataContext.find(".upload-file-version-label").show();
                    $dataContext.find(".upload-folder").hide();
                    $dataContext.find(".upload-file-tag").val(currentDocument.Tags);
                }
                else {
                    $dataContext.find(".upload-version").hide();
                }
            }
        });
    };
</script>

<style>
    #file-input {
        display: none;
    }

    .km-accent.test {
        background: red;
    }

    .addfile-btn {
        width: 100% !important;
        border: 0 !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }

        .addfile-btn.small {
            height: 100px;
            line-height: 64px;
            font-size: 32px;
        }

        .addfile-btn.big {
            height: 100%;
            text-align: center;
        }

            .addfile-btn.big span {
                top: 45%;
                position: relative;
            }

    .km-scroll-container {
        position: absolute;
        height: 100%;
        width: 100%;
    }
    /* File upload rows */
    .file-upload-row .km-inline-field {
        overflow: visible;
        padding-left: 1em !important;
    }

        .file-upload-row .km-inline-field input {
            padding-left: 1em !important;
        }

        .file-upload-row .km-inline-field:last-of-type {
            padding: 0;
            padding-bottom: 40px;
            padding-top: 40px;
        }

    .file-upload-row .file-upload-row-header {
        padding: 5px;
        margin-bottom: 5px;
        background-color: #2F7EC5;
        line-height: 32px;
    }

        .file-upload-row .file-upload-row-header input {
            position: relative !important;
            transform: none !important;
            width: 92% !important;
            text-align: center !important;
            color: white !important;
            padding-left: 8% !important;
        }

        .file-upload-row .file-upload-row-header div {
            display: inline-block;
            width: 32px;
            height: 100%;
            text-align: center;
        }

            .file-upload-row .file-upload-row-header div a {
                display: block;
                color: white;
            }
</style>
