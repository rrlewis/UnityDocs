<div id="addfile" data-model="addfileViewModel" data-bind="events: { show: onViewShow, beforeunload: test }" data-role="view" data-layout="default-layout" data-title="Add File">
    <!--<form action="http://apprentice2/unity/api/documentmanagement/UploadDocument" method="post" name="addfile">
        <ul data-role="listview">
            <li class="center-text" data-bind="visible: gotFile">
                <img alt="Selected image" height="250" width="250" data-bind="attr: {src: filePath}"/>
            </li>
            <li style="display:none;">
                <input id="addfile-file" type="file" name="files[]" data-url="server/php/" data-bind="events: { change:onFileGet }">
            </li>
             Hidden
            <li data-bind="visible:gotFile">
                <label>
                    Filename
                    <input type="text" data-bind="value:fileData.FileName" />
                </label>
            </li>
            <li data-bind="visible:gotFile">
                <label>
                    Folder
                    <select data-bind="source:folderData, value:fileData.Folder"></select>
                </label>
            </li>
            <li data-bind="visible:gotFile">
                <label>
                    Comments
                    <textarea style="resize:vertical;max-height:200px;" data-bind="value:fileData.VersionComments"></textarea>
                </label>
            </li>
            <li data-bind="visible:gotFile">
                <label>
                    Tags
                    <input type="text" data-bind="value:fileData.Tags" />
                </label>
            </li>
            <li data-bind="visible:gotFile">
                <label>
                    Check out file
                    <input type="checkbox" data-bind="value:fileData.CheckoutAfterUpload" />
                </label>
            </li>
            <li data-bind="visible:gotFile">
                <div class="center-text">
                    <a data-role="button" data-bind="click:submitForm" class="km-primary">Upload</a>
                </div>
            </li>
        </ul>
    </form>
    <a data-role="button" class="add-file" data-bind="click:fromCamera,invisible:gotFile"><i class="fa fa-camera"></i>&nbsp;Camera</a>
    <a data-role="button" class="add-file" data-bind="click:fromStorage,invisible:gotFile"><i class="fa fa-hdd-o"></i>&nbsp;Storage</a>-->
    <input id="addfile-file" type="file" name="files[]" data-url="server/php/" data-bind="events: { change:onFileGet }">
</div>

<script>
    var addfileViewModel = {};
    $("#fileupload").fileupload();
    $(function (jQuery) {
        addfileViewModel = new kendo.observable({
            defaults: [
                    ['filePath', ""],
                    ['folderData', []],
                    ['fileData', {
                        FileName: "",
                        VersionComments: "",
                        Tags: "",
                        Folder: "",
                        CheckoutAfterUpload: false,
                    }
                    ],
                    ['libraryName', ""],
                    ['gotFile', false]
            ],
            filePath: "",
            from: "",
            folderData: [],
            fileData: {
                FileName: "",
                VersionComments: "",
                Tags: "",
                Folder: "",
                CheckoutAfterUpload: false,
            },
            libraryName: "",
            gotFile: false,
            openFileActionSheet: function (e) {
                var $this = this;
                var options = {
                    'androidTheme': window.plugins.actionsheet.ANDROID_THEMES.THEME_DEVICE_DEFAULT_DARK, // default is THEME_TRADITIONAL
                    'title': 'Where would you like to add a file from?',
                    'buttonLabels': ['Camera', 'Storage'],
                    'androidEnableCancelButton': true, // default false
                    'addCancelButtonWithLabel': 'Cancel',
                };
                window.plugins.actionsheet.show(options, function (buttonIndex) {
                    setTimeout(function () {
                        var buttonPressed = options.buttonLabels[buttonIndex - 1];
                        switch (buttonPressed) {
                            case 'Camera':

                                break;
                            case 'Storage':
                                $this.openFileDialog(e);
                                break;
                        }
                    });
                });
            },
            fromCamera: function (e) {
                var $this = this;
                function gotPicture(filePath, b, c) {
                    $this.set('from', 'camera');
                    function uploadSuccess(a, b, c) {
                        debugger;
                    }
                    function uploadFail(a, b, c) {
                        debugger;
                    }
                    debugger;

                    var fileName = filePath.split('/').pop();
                    $this.set('fileData.FileName', fileName);
                    $this.set('filePath', filePath);
                    $this.set('gotFile', true);

                    //var options = new FileUploadOptions();
                    //options.fileKey = "file";
                    //var userid = '123456';
                    //options.fileName = 'test.jpg';
                    //options.mimeType = "image/jpg";

                    //var params = new Object();
                    //params.imageURI = imageURI;
                    //params.formData = {}; // here
                    //options.params = params;
                    //options.chunkedMode = false;
                    //var ft = new FileTransfer();
                    //var url = "Your_Web_Service_URL";
                    //ft.upload(imageURI, url, win, fail, options, true);

                }
                function failedToGetPicture(error) {
                    debugger;
                }

                navigator.camera.getPicture(gotPicture, failedToGetPicture, {
                    quality: 50, destinationType: Camera.DestinationType.FILE_URI
                });

            },
            fromStorage: function (e) {
                $("#addfile-file").click();
            },
            onFileGet: function (e) {
                //file selection done
                var input = $(e.target);
                var filePath = input.val();

                var fileName = filePath.split('\\').pop();
                this.set('from', 'camera');
                this.set('fileData.FileName', fileName);
                this.set('filePath', filePath);
                this.set('gotFile', true);
            },
            uploadFile: function () {
                // upload file to server in the directory where upload was pressed.
                var form = $("#addfile form");
                var formData = {};

                formData.FileName = this.fileData.FileName;
                formData.VersionComments = this.fileData.VersionComments;
                formData.Tags = this.fileData.Tags;
                formData.Folder = this.fileData.Folder;
                formData.CheckoutAfterUpload = this.CheckoutAfterUpload;

                form.formData = formData;
                debugger;
                form.submit(function (result) {
                    debugger;
                });
                debugger;

            },
            submitForm: function (e) {
                var $this = this;
                var from = $this.get('from');
                $this.set('from', '');
                if (from == 'camera') {
                    var fileTransfer = new FileTransfer();
                    var options = new FileUploadOptions();

                    options.fileName = $this.get('fileData.FileName');
                    options.params = {
                        fileData: $this.fileData
                    };

                    debugger;
                    fileTransfer.upload($this.filePath, encodeURI(api.rootUrl + 'documentmanagement/UploadDocument'),
                        function (a, b, c) { // Success
                            debugger;
                        },
                        function (error) { // Fail
                            debugger;
                            console.log(error);
                        },
                        options);
                } else if (from == 'storage') {
                    var data = $("#addfile form[name=addfile]");
                    data.fileData = $this.fileData;
                }

            },
            test: function (e) {

            },
            onViewShow: function (e) {
                this.reset();
                var params = e.view.params;
                // get library folders.
                $("#addfile-file").fileupload({
                    autoUpload: false,
                    url: api.rootUrl + '/api/DocumentManagement/UploadDocument',
                    add: function (e, data) {
                        debugger;
                        $.each(data.files, function (index, file) {
                            debugger;
                            var fileName = file.name;
                            var extension = fileName.substr(fileName.lastIndexOf("."));
                            var fileNameWithoutExtension = fileName.substr(0, fileName.lastIndexOf("."));
                            var allowUpload = true;
                            var currentDocument;

                            // Check whether this file already exists in this folder. If so, then display the 'check-in' option rather than upload.
                            for (var i = 0; i < that.Documents.length; i++) {

                                var item = that.Documents[i];
                                if (!item.IsFolder && item.Filename && item.Filename.toLowerCase() == fileName.toLowerCase()) {

                                    // Check the 'check-out' status of this document
                                    if (item.CheckedOutBy) {

                                        if (item.CheckedOutBy != sanderson.user.name) {
                                            // The document is checked out to another user
                                            alert("This document has been checked out by another user");
                                            allowUpload = false;
                                            data.abort();
                                        }
                                        else {
                                            currentDocument = item;
                                        }
                                    }
                                    else {

                                        if (confirm("You must check out this document before uploading a new version. Would you like to do this now?")) {

                                            // Check out the document now. If not successful then remove the document from the list again

                                            checkOut(item).done(function (result) {

                                            }).fail(function (result) {

                                                // Couldn't check out the document, display an error and remove the document from the upload list
                                                alert("Failed to check out document");


                                                // TODO: This needs testing
                                                data.abort();
                                            });

                                            currentDocument = item;
                                        }
                                        else {
                                            //allowUpload = false;
                                            //data.abort();
                                        }
                                    }

                                    // The file was found so stop looking for it.
                                    break;
                                }
                            }

                            if (allowUpload) {

                                var template = kendo.template($("#img9a-upload-document-row").html());
                                data.currentDocument = currentDocument;
                                data.context = $(template({})).data(data);

                                data.context.appendTo('.files-list');

                                var $dataContext = $(data.context);
                                $dataContext.attr("data-filename", fileName);

                                $dataContext.find(".upload-file-name").val(fileNameWithoutExtension);
                                $dataContext.find(".upload-file-extension").text(extension.toLowerCase());
                                $dataContext.find(".upload-file-size").text(parseInt(file.size / 1024) + " KB");
                                $dataContext.find(".upload-folder").val(that.CurrentFolder.toUpperCase());
                                $dataContext.find(".remove-file-btn").on('click', function () {
                                    var $this = $(this);
                                    var data = $this.parents(".upload-file-row").data();
                                    data.abort();
                                    $this.parents(".upload-file-row").remove();
                                });

                                kendo.bind($dataContext, that);

                                if (currentDocument) {
                                    // This is a check in of an existing document rather than an upload of a new one.
                                    $dataContext.find(".upload-document-type").text("Check In Document");
                                    $dataContext.find(".upload-file-folder-label").hide();
                                    $dataContext.find(".upload-file-version-label").show();
                                    $dataContext.find(".upload-folder").hide();
                                    $dataContext.find(".upload-file-tag").val(currentDocument.Tags);
                                }
                                else {
                                    $dataContext.find(".upload-version").hide();
                                }
                            }
                        });

                    },
                });
                var $this = this;
                this.set('libraryName', params.libraryName);
                api.documentService().getFolderList(params.libraryName).then(function (response) {
                    var results = response.results;
                    $this.set('folderData', results);
                });
                globalOnViewShow(e);
            },
            reset: function (e) {
                for (var x = 0; x < this.defaults.length; x++) {
                    var propName = this.defaults[x][0];
                    var propVal = this.defaults[x][1];
                    if (this.hasOwnProperty(propName)) {
                        this.set(propName, propVal);
                    }
                }
            }
        });
    });

    var g = function (e, data) {
        $.each(data.files, function (index, file) {

            var fileName = file.name;
            var extension = fileName.substr(fileName.lastIndexOf("."));
            var fileNameWithoutExtension = fileName.substr(0, fileName.lastIndexOf("."));
            var allowUpload = true;
            var currentDocument;

            // Check whether this file already exists in this folder. If so, then display the 'check-in' option rather than upload.
            for (var i = 0; i < that.Documents.length; i++) {

                var item = that.Documents[i];
                if (!item.IsFolder && item.Filename && item.Filename.toLowerCase() == fileName.toLowerCase()) {

                    // Check the 'check-out' status of this document
                    if (item.CheckedOutBy) {

                        if (item.CheckedOutBy != sanderson.user.name) {
                            // The document is checked out to another user
                            alert("This document has been checked out by another user");
                            allowUpload = false;
                            data.abort();
                        }
                        else {
                            currentDocument = item;
                        }
                    }
                    else {

                        if (confirm("You must check out this document before uploading a new version. Would you like to do this now?")) {

                            // Check out the document now. If not successful then remove the document from the list again

                            checkOut(item).done(function (result) {

                            }).fail(function (result) {

                                // Couldn't check out the document, display an error and remove the document from the upload list
                                alert("Failed to check out document");


                                // TODO: This needs testing
                                data.abort();
                            });

                            currentDocument = item;
                        }
                        else {
                            //allowUpload = false;
                            //data.abort();
                        }
                    }

                    // The file was found so stop looking for it.
                    break;
                }
            }

            if (allowUpload) {

                var template = kendo.template($("#img9a-upload-document-row").html());
                data.currentDocument = currentDocument;
                data.context = $(template({})).data(data);

                data.context.appendTo('.files-list');

                var $dataContext = $(data.context);
                $dataContext.attr("data-filename", fileName);

                $dataContext.find(".upload-file-name").val(fileNameWithoutExtension);
                $dataContext.find(".upload-file-extension").text(extension.toLowerCase());
                $dataContext.find(".upload-file-size").text(parseInt(file.size / 1024) + " KB");
                $dataContext.find(".upload-folder").val(that.CurrentFolder.toUpperCase());
                $dataContext.find(".remove-file-btn").on('click', function () {
                    var $this = $(this);
                    var data = $this.parents(".upload-file-row").data();
                    data.abort();
                    $this.parents(".upload-file-row").remove();
                });

                kendo.bind($dataContext, that);

                if (currentDocument) {
                    // This is a check in of an existing document rather than an upload of a new one.
                    $dataContext.find(".upload-document-type").text("Check In Document");
                    $dataContext.find(".upload-file-folder-label").hide();
                    $dataContext.find(".upload-file-version-label").show();
                    $dataContext.find(".upload-folder").hide();
                    $dataContext.find(".upload-file-tag").val(currentDocument.Tags);
                }
                else {
                    $dataContext.find(".upload-version").hide();
                }
            }
        });
    };
</script>
<style>
    #addfile [data-role=content] {
    }

    #addfile .add-file {
        padding: 0;
        border: 0;
        height: 50%;
        box-sizing: border-box;
        margin: 0;
        width: 100%;
        line-height: 40vh;
        font-weight: 900;
        font-size: 28px;
        border-radius: 0;
    }

        #addfile .add-file:first-of-type {
            border-bottom: 1px solid rgba(0, 0, 0, 0.33);
        }

    #addfile .km-scroll-container {
        box-sizing: border-box;
        height: 100%;
        position: absolute;
        width: 100%;
    }
</style>