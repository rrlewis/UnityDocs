<div id="library" data-reload="true" data-role="view" data-layout="default-layout" data-title="Library">
    <ul data-role="listview" class="data-source sortable" data-template="library-item-template" data-source="scope.data" data-pull-to-refresh="true"></ul>
</div>

<div data-role="modalview" id="info-modal" style="width: 100%; height: 100%;" data-modal="false">
    <div data-role="header">
        <div data-role="navbar">
            <a data-align="right" data-click="closeModalView" data-role="button">Delete</a>
            <span data-role="view-title"></span>
            <a data-align="left" data-click="closeModalView" data-role="button"><i class="fa fa-chevron-left"></i></a>
        </div>
    </div>
    <form name="extra-info">
        <ul data-role="listview">
            <li>
                <label>
                    Type
                    <input data-field="Type" name="Type" type="text" readonly />
                </label>
            </li>
            <li>
                <label>
                    Name
                    <input data-field="Description" name="Description" type="text" readonly />
                </label>
            </li>
            <li>
                <label>
                    Modified
                    <input data-field="Modified" name="Modified" type="text" readonly />
                </label>
            </li>
            <li>
                <label>
                    Modified By
                    <input data-field="ModifiedBy" name="ModifiedBy" type="text" readonly />
                </label>
            </li>
            <li>
                <label>
                    Checked Out By
                    <input data-field="CheckedOutByFullName" name="CheckedOutByFullName" type="text" readonly />
                </label>
            </li>
            <li>
                <label>
                    Tags 
                    <input data-field="Tags" name="Tags" type="text" placeholder="A string with each tag delimited by a ; (semi-colon)." />
                </label>
            </li>
            <li>
                <label>
                    Comments
                    <textarea data-field="Comments" name="Comments" readonly style="resize:vertical;">

                    </textarea>
                </label>
            </li>
        </ul>
    </form>
    <div data-role="footer">
        <div data-role="navbar">
            <a data-align="right" data-click="openVersionHistory" data-role="button">Version History</a>
            <a data-align="right" data-click="saveInfo" data-role="button">Done</a>
        </div>
    </div>
</div>

<div data-role="modalview" id="version-history" style="width:100%; height:100%;" data-modal="false">
    <div data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
            <a data-align="left" data-click="closeVersionHistory" data-role="button"><i class="fa fa-close"></i></a>
        </div>
    </div>
    <ul data-role="listview" class="data-source sortable" data-template="version-history-template"></ul>
</div>

<!-- List Item template -->
<script type="text/kendo-x-tmpl" id="library-item-template">
    <a data-role="button" class="km-primary km-button-right km-icon-button" data-click="openInfoModal" data-description="#:Description#"><i class="fa fa-info"></i></a>

    <!-- FIX THIS TEMPLATE -->
    # if (Type == 'FOLDER') { #
    <a href="\\#views/library.html?indextypeorlibrary=#:scope.libraryName#&subfolder=#:Description#&key" class="library-link">
        <i class="km-thumbnail fa fa-folder font-size-36"></i>
        <h4>#:Description#</h4>
        <p class="extra-info">Last modified at #:Modified# by #:ModifiedBy#.</p>
        <p class="extra-info">
            &nbsp;
        </p>
    </a>
    # } else { #
    <a href="\\#views/file.html?imageID=#:ImageID#&description=#:Description#" class="library-link">
        # if (Type == 'DOCX' || Type == 'DOC') { #
        <i class="km-thumbnail fa fa-file-word-o font-size-36"></i>
        # } else if (Type == 'PNG' || Type == 'JPG' || Type == 'TIF') { #
        <i class="km-thumbnail fa fa-file-image-o font-size-36"></i>
        # } else if (Type == 'XLSM' || Type == 'XLS' || Type == 'XLSX') { #
        <i class="km-thumbnail fa fa-file-excel-o font-size-36"></i>
        # } else if (Type == 'PDF') { #
        <i class="km-thumbnail fa fa-file-pdf-o font-size-36"></i>
        # } else if (Type == 'TXT') { #
        <i class="km-thumbnail fa fa-file-text-o font-size-36"></i>
        # } else { #
        <i class="km-thumbnail fa fa-file-o font-size-36"></i>
        # } #

        <h4>#:Description#</h4>

        <p class="extra-info">Last modified at #:Modified# by #:ModifiedBy#.</p>
        # if (CheckedOutBy == null){ #
        <p class="extra-info">
            Checked Out By: Nobody.
        </p>
        # } else { #
        <p class="extra-info">
            Checked Out By: #:CheckedOutBy#.
        </p>
        # } #
    </a>
    # } #
</script>

<!-- Version History template -->
<script type="text/kendo-x-tmpl" id="version-history-template">
    <div>
        <ul>
            <li>
                <span class="bold-text">Version:</span> #:VersionNumber#
            </li>
            <li>
                <span class="bold-text">Last Modified At:</span> #:Modified#
            </li>
            <li>
                <span class="bold-text">Last Modified By:</span> #:ModifiedBy#
            </li>
            <li>
                <br />
                <span class="bold-text">Comments</span>
                <br />
                <br />
                # if (Comments != null) { #
                #:Comments#
                # } #
            </li>
        </ul>
    </div>
</script>

<script>
    var originalData = {};
    function closeModalView(e) {
        // find the closest modal view, relative to the button element.
        var modalView = e.sender.element.closest("[data-role=modalview]").data("kendoMobileModalView");
        modalView.close();
    }

    function openInfoModal(e) {
        var modalView = $("#info-modal").data("kendoMobileModalView");
        var data = e.button.data();
        var libraryItems = scope.data.data();
        for (var x = 0; x < libraryItems.length; x++) {
            scope.selectedItem = libraryItems[x];
            if (scope.selectedItem.Description == data.description) {
                break;
            }
        }
        for (var prop in scope.selectedItem) {
            if (scope.selectedItem.hasOwnProperty(prop)) {
                if ($("[data-field=" + prop + "]").exists()) {
                    $("[data-field=" + prop + "]").val(scope.selectedItem[prop]);
                }
            }
        }
        api.documentService().getVersionHistory(scope.libraryName, scope.selectedItem.ImageID).then(function (results) {
            var listView = $("#version-history ul.data-source").data("kendoMobileListView");
            var dataSource = new kendo.data.DataSource({ data: results.results });
            $("#info-modal textarea[data-field=Comments").val(results.results[0].Comments == null ? 'No comments.' : results.results[0].Comments);
            $("#version-history [data-role=view-title]").text(scope.selectedItem.Description + " History");
            listView.setDataSource(dataSource);
        });

        $("#info-modal [data-role=view-title]").text(data.description);
        modalView.open();
        originalData = $("form[name=extra-info]").serializeObject();
        originalData.ImageID = scope.selectedItem.ImageID;
    }

    function deleteFolder() {
        var folderName = $("#info-modal [data-field=Description]").val();

        var libraryName = scope.libraryName;

        api.documentService().removeFolderFromLibrary(scope.libraryName, folderName).then(function (results) {
            debugger;

        })
        debugger;
    }

    function saveInfo(e) {
        var newData = $("form[name=extra-info]").serializeObject();
        if (newData.Tags != originalData.Tags) {
            api.documentService().updateDocumentTags(originalData.ImageID, newData.Tags).then(function (result) {
                debugger;
            })
        }
        originalData = {};
        closeModalView(e);
    }

    function openVersionHistory(e) {
        var modalView = $("#version-history").data("kendoMobileModalView");
        modalView.open();
    }

    function closeVersionHistory(e) {
        $("form[name=extra-info]").trigger('reset');
        closeModalView(e);
    }
</script>

<style>
    #version-history div ul{
        list-style:none;
        padding:0;
    }
    #version-history div ul li{
        margin-top:10px;
        margin-bottom:10px;
        padding-left:10px;
        padding-right:10px;
    }
</style>